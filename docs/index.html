<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            body > canvas {
                width: 100%;
                border: 2px solid black;
            }
            body > #canvas1 {
                height: 6px;
            }
            body > #canvas2 {
                height: 256px;
            }
            textarea {
                width: 60em;
                max-width: 100%;
                height: 60em;
            }
        </style>
    </head>
    <body>

    <canvas id="canvas1"></canvas>
    <canvas id="canvas2"></canvas>
    <textarea id="output" readonly></textarea>
<script>
'use strict';
var pixelsStrip = 299,
    pixelsRing1 = 24,
    pixelsRing2 = 12,
    pixelsTotal = pixelsStrip + pixelsRing1 + pixelsRing2,
    canvas1 = document.getElementById('canvas1'),
    width = canvas1.width = pixelsTotal * 4,
    height = canvas1.height = 1,
    ctx = canvas1.getContext('2d'),
    pulse = {
        frames: [],
        buffers: [],
        frame: 0,
        length: 188,
        duration: 40,
    },
    animation = pulse;

// Generate pulse sequence
function setPixel(x, r, g, b) {
    var i = x * 16,
        j = x * 3;
    buffer[j+1] = img[i+ 8] = img[i+4] = img[i+0] = r;
    buffer[j+0] = img[i+ 9] = img[i+5] = img[i+1] = g;
    buffer[j+2] = img[i+10] = img[i+6] = img[i+2] = b;
    img[i+15] = img[i+11] = img[i+7] = img[i+3] = 255;
}

for (var t = 0; t < pulse.length; t++) {
    var imageData = ctx.createImageData(width, height),
        img = imageData.data,
        buffer = new Uint8Array(pixelsTotal * 3);

    var pr = Math.PI * t / pulse.length,
        or = 0.009,
        pg = -Math.PI * t / pulse.length,
        og = 0.009,
        pb = Math.PI * 4 * t / pulse.length,
        ob = 0.005;

    for (var x = 0; x < pixelsStrip; x++) {
        setPixel(x,
            Math.pow(Math.abs(Math.sin(pr += or)), 256) * 255,
            Math.pow(Math.abs(Math.sin(pg += og)), 256) * 255,
            Math.sin(pb += ob) * 127 + 128
        );
    }

    var r1p = Math.PI * 4 * t / pulse.length,
        r1 = Math.pow(Math.abs(Math.sin(r1p)), 4) * 255,
        r1c = [[1,0,0], [1,0,1], [0,0,1], [0,1,1]][ Math.floor(r1p / Math.PI % 4)];

    for (var x = pixelsStrip; x < pixelsStrip + pixelsRing1; x++) {
        setPixel(x, r1 * r1c[0], r1 * r1c[1], r1 * r1c[2]);
    }

    var r2p = Math.PI * 4 * t / pulse.length + Math.PI / 2,
        r2 = Math.pow(Math.abs(Math.sin(r2p)), 4) * 255,
        r2c = [[0,1,0], [1,1,0], [1,0,0], [1,1,1]][ Math.floor(r2p / Math.PI % 4)];

    for (var x = pixelsStrip + pixelsRing1; x < pixelsStrip + pixelsRing1 + pixelsRing2; x++) {
        setPixel(x, r2 * r2c[0], r2 * r2c[1], r2 * r2c[2]);
    }

    pulse.frames.push([imageData, pulse.duration]);
    pulse.buffers.push(buffer);
}



// Generate flash sequence
function getBuffer(color) {
    var imageData = ctx.createImageData(width, height),
        img = imageData.data,
        buffer = new Uint8Array(pixelsTotal * 3);

    for (var x = 0; x < pixelsStrip; x++) {
        var i = x * 16,
            b = x * 3;
        buffer[b+1] = img[i+ 8] = img[i+4] = img[i+0] = color[0];
        buffer[b+0] = img[i+ 9] = img[i+5] = img[i+1] = color[1];
        buffer[b+2] = img[i+10] = img[i+6] = img[i+2] = color[2];
        img[i+15] = img[i+11] = img[i+7] = img[i+3] = 255;
    }

    return {
        image: imageData,
        buffer: buffer
    }
}

var red    = getBuffer([255, 0, 0]),
    green  = getBuffer([0, 255, 0]),
    blue   = getBuffer([0, 0, 255]),
    yellow = getBuffer([255, 255, 0]),
    purple = getBuffer([255, 0, 255]),
    cyan   = getBuffer([0, 255, 255]),
    white  = getBuffer([255, 255, 255]),
    black  = getBuffer([0, 0, 0]),
    colors = [red, green, blue, yellow, purple, cyan],
    flash = {
        frames: [],
        buffers: [],
        frame: 0,
        flashDuration: 500,
        flashPause: 500,
        flickerDuration: 20,
        flickerDelay: 20,
        flickerPause: 50,
        done: function() {
            animation = pulse;
        }
    };

flash.frames.push(
    [white.image, flash.flashDuration],
    [black.image, flash.flashPause],
    [white.image, flash.flashDuration],
    [black.image, flash.flashPause]
);

flash.buffers.push(
    white.buffer,
    black.buffer,
    white.buffer,
    black.buffer
);

for (var i = 0; i < colors.length; i++) {
    for (var n = 0; n < 4; n++) {
        flash.frames.push([colors[i].image, flash.flickerDuration], [black.image, flash.flickerDelay]);
        flash.buffers.push(colors[i].buffer, black.buffer);
    }
    flash.frames.push([black.image, flash.flickerPause]);
    flash.buffers.push(black.buffer);
}

flash.frames.push([white.image, flash.flashDuration * 2], [black.image, flash.flashPause]);
flash.buffers.push(white.buffer, black.buffer);


// Visualize waveform
var canvas2 = document.getElementById('canvas2'),
    width2 = canvas2.width = pixelsTotal,
    height2 = canvas2.height = 256,
    ctx2 = canvas2.getContext('2d');

ctx2.fillStyle = 'black';

function verticalLine(imageData, x, height, colorOffset) {
    for (var y = height2 - height - 1; y < height2; y++) {
        imageData.data[y * width2 * 4 + x * 4 + colorOffset] = 255;
    }
}

function drawWave(buffer) {
    var imageData = ctx2.createImageData(width2, height2);
    for (var x = 0; x < width2; x++) {
        var j = x * 3;
        verticalLine(imageData, x, buffer[j+1], 0);
        verticalLine(imageData, x, buffer[j+0], 1);
        verticalLine(imageData, x, buffer[j+2], 2);
        verticalLine(imageData, x, 255, 3);
    }
    ctx2.putImageData(imageData, 0, 0);
}


// Run animation loop
(function updateAnimationFrame() {
    var frame = animation.frames[animation.frame],
        buffer = frame[0],
        delay = frame[1];
    ctx.putImageData(buffer, 0, 0);
    drawWave(animation.buffers[animation.frame]);
    setTimeout(updateAnimationFrame, delay);

    if (++animation.frame >= animation.frames.length) {
        animation.frame = 0;
        if (animation.done) animation.done();
    }
})();


// Trigger flash on check in event.
var eventSourceURL = 'https://jullunch-backend.athega.se/stream',
    eventSource = new EventSource(eventSourceURL);

eventSource.addEventListener("jullunch.check-in", function(event) {
    animation = flash;
});


// Generate source code for buffers.
var output = document.getElementById('output'),
    anims = {pulse: pulse, flash: flash};
output.value = 'module.exports = {\n';
for (var name in anims) {
    output.value += name + ': [\n';
    for (var i = 0; i < anims[name].frames.length; i++) {
        var buffer = anims[name].buffers[i],
            delay = anims[name].frames[i][1];
//        output.value += '["' + btoa(String.fromCharCode.apply(null, buffer)) + '", ' + delay + '],\n';
        output.value += '[new Buffer([' + Array.from(buffer) + ']), ' + delay + '],\n';
    }
//    output.value += '].map(function(frame) { return [new Buffer(frame[0], "base64"), frame[1]]; }),\n';
    output.value += '],\n';
}
output.value += '};\n';



</script>
    </body>
</html>
